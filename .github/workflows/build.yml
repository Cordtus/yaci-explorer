name: Deploy Production

on:
  push:
    branches: [main]

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  FLY_APP: yaci-explorer

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Log in to Fly Registry
        uses: docker/login-action@v3
        with:
          registry: registry.fly.io
          username: x
          password: ${{ secrets.FLY_API_TOKEN }}

      - name: Get merge commit SHA
        id: sha
        run: |
          # For PRs merged to main, get the head SHA from the merge commit
          MERGE_SHA=$(git log -1 --format=%H)
          # Get the PR head SHA (second parent of merge commit)
          PR_SHA=$(git log -1 --format=%P | awk '{print $2}')
          if [ -n "$PR_SHA" ]; then
            echo "sha=$PR_SHA" >> $GITHUB_OUTPUT
          else
            # Direct push to main - build fresh
            echo "sha=" >> $GITHUB_OUTPUT
          fi

      - name: Deploy from existing image
        if: steps.sha.outputs.sha != ''
        run: flyctl deploy --image registry.fly.io/${{ env.FLY_APP }}:${{ steps.sha.outputs.sha }}
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}

      - name: Build and deploy (direct push)
        if: steps.sha.outputs.sha == ''
        run: flyctl deploy
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
